name: Node.js Release PR (reusable)

on:
  workflow_call:
    inputs:
      new-version:
        description: New version to release (patch, minor, major, or auto)
        required: false
        default: auto
        type: string
      reviewers:
        description: Reviewers for the pull request (comma-separated)
        required: false
        type: string

jobs:
  release-pr:
    runs-on: ubuntu-slim
    permissions:
      contents: write
      pull-requests: write
    timeout-minutes: 10
    concurrency: ${{ github.workflow }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0 # for changelog generation from commit history

      - name: Set up Node.js LTS
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: "lts/*"
          cache: npm

      - name: Update npm to latest
        run: |
          npm install --global npm@latest
          echo "Successfully updated npm to $(npm -v)"

      - name: Install dependencies
        run: npm ci

      - name: Determine version bump type
        id: determine-version
        env:
          INPUT_VERSION: ${{ inputs.new-version }}
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${INPUT_VERSION}" = "auto" ]; then
            # Get the latest tag
            latest_tag=$(gh release view --json tagName --jq .tagName 2>/dev/null || echo "")
            
            if [ -z "${latest_tag}" ]; then
              # If no releases exist, get all commits
              commits=$(git log --pretty=format:"%s" HEAD)
            else
              # Get commits since the latest tag
              commits=$(git log --pretty=format:"%s" "${latest_tag}..HEAD")
            fi
            
            # Determine version bump type based on conventional commits
            # Check for breaking changes (feat! or BREAKING CHANGE)
            if echo "${commits}" | grep -qE '^[a-zA-Z]+(\([^)]*\))?!:' || echo "${commits}" | grep -q "BREAKING CHANGE"; then
              version_type="major"
            # Check for features
            elif echo "${commits}" | grep -qiE '^feat(\([^)]*\))?:'; then
              version_type="minor"
            # Otherwise it's a patch
            else
              version_type="patch"
            fi
            
            echo "version-type=${version_type}" >> "${GITHUB_OUTPUT}"
            echo "::notice::Auto-detected version bump type: ${version_type}"
          else
            # Use the provided version
            echo "version-type=${INPUT_VERSION}" >> "${GITHUB_OUTPUT}"
          fi

      - name: Bump version
        id: bump-version
        env:
          VERSION_TYPE: ${{ steps.determine-version.outputs.version-type }}
        run: |
          npm version "${VERSION_TYPE}" --no-git-tag-version
          echo "new-version=$(jq -r '.version' package.json)" >> "${GITHUB_OUTPUT}"

      - name: Get additional info
        id: get-info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "latest-tag=$(gh release view --json tagName --jq .tagName)" >> "${GITHUB_OUTPUT}"

      - name: Create pull request
        env:
          GH_TOKEN: ${{ github.token }}
          NEW_VERSION: ${{ steps.bump-version.outputs.new-version }}
          LATEST_TAG: ${{ steps.get-info.outputs.latest-tag }}
          REVIEWERS: ${{ inputs.reviewers }}
        run: |
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR_ID}+${GITHUB_ACTOR}@users.noreply.github.com"

          branch_name="release/v${NEW_VERSION}"
          commit_message="chore: release v${NEW_VERSION}"
          git checkout -b "${branch_name}"
          git commit -am "${commit_message}"
          git push origin "${branch_name}"

          cat <<EOF > "${RUNNER_TEMP}/pr_body.txt"
          This PR prepares the release of **v${NEW_VERSION}**.

          Changes: <${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/compare/${LATEST_TAG}...${branch_name}>

          This PR was generated by [this action run](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}).
          EOF

          gh pr create \
            --title "${commit_message}" \
            --body-file "${RUNNER_TEMP}/pr_body.txt" \
            --reviewer "${REVIEWERS}" \
            --assignee "${GITHUB_ACTOR}"

          pr_url=$(gh pr view --json url --jq '.url')
          echo "::notice::Created pull request for releasing v${NEW_VERSION}: ${pr_url}"
