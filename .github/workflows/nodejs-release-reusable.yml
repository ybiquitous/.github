name: Node.js Release (reusable)

on:
  workflow_call:
    inputs:
      publish:
        description: Set true if publishing to registry
        required: false
        default: true
        type: boolean
      create-release:
        description: Set true if creating release
        required: false
        default: true
        type: boolean
      draft:
        description: Set true if creating draft release
        required: false
        default: true
        type: boolean

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    timeout-minutes: 10
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Set up Node.js LTS
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: "lts/*"
          registry-url: "https://registry.npmjs.org"

      - name: Update npm to latest
        run: |
          npm install --global npm@latest
          echo "Successfully updated npm to $(npm -v)"

      - name: Install dependencies
        run: npm ci

      - name: Publish to npm registry
        if: ${{ inputs.publish }}
        run: |
          npm publish
          package_name=$(jq -r '.name' package.json)
          echo "::notice::Published https://www.npmjs.com/package/${package_name}"

      - name: Create GitHub release
        if: ${{ inputs.create-release }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRAFT_RELEASE: ${{ inputs.draft }}
        run: |
          notes_file="${RUNNER_TEMP}/notes.txt"
          echo "See the [changelog](https://github.com/${GITHUB_REPOSITORY}/blob/${GITHUB_REF_NAME}/CHANGELOG.md) for details." >> "${notes_file}"

          prev_tag_name=$(gh release view --json tagName --jq .tagName || echo '')

          if [[ -n "${prev_tag_name}" ]]; then
            echo '' >> "${notes_file}"
            echo "https://github.com/${GITHUB_REPOSITORY}/compare/${prev_tag_name}...${GITHUB_REF_NAME}" >> "${notes_file}"
          fi

          if [[ "${DRAFT_RELEASE}" == "true" ]]; then
            options='--draft'
          else
            options=''
          fi

          gh release create "${GITHUB_REF_NAME}" --notes-file "${notes_file}" ${options}

          release_url=$(gh release view "${GITHUB_REF_NAME}" --json 'url' --jq '.url')

          if [[ "${DRAFT_RELEASE}" == "true" ]]; then
            echo "::notice::Released ${release_url} as draft. Edit it to publish."
          else
            echo "::notice::Released ${release_url}"
          fi
